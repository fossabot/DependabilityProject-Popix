<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CarrelloDAOImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">popix</a> &gt; <a href="index.source.html" class="el_package">com.popx.persistenza</a> &gt; <span class="el_source">CarrelloDAOImpl.java</span></div><h1>CarrelloDAOImpl.java</h1><pre class="source lang-java linenums">package com.popx.persistenza;

import com.popx.modello.CarrelloBean;
import com.popx.modello.ProdottoCarrelloBean;
import javax.sql.DataSource;
import java.sql.*;
import java.util.*;

public class CarrelloDAOImpl implements CarrelloDAO {
    private DataSource ds;

    /*@ public model boolean available;
      @ public invariant ds != null &amp;&amp; available;
      @ represents available &lt;- ds != null;
      @*/

<span class="nc" id="L17">    public CarrelloDAOImpl() {</span>
<span class="nc" id="L18">        this.ds = DataSourceSingleton.getInstance();</span>
<span class="nc" id="L19">    }</span>

    @Override
    /*@ public normal_behavior
      @   requires carrello != null
      @        &amp;&amp; carrello.getClienteEmail() != null &amp;&amp; !carrello.getClienteEmail().isEmpty()
      @        &amp;&amp; carrello.getProdottiCarrello() != null
      @        &amp;&amp; (\forall int i; 0 &lt;= i &amp;&amp; i &lt; carrello.getProdottiCarrello().size();
      @              carrello.getProdottiCarrello().get(i) != null
      @           &amp;&amp; carrello.getProdottiCarrello().get(i).getProdottoId() != null
      @           &amp;&amp; !carrello.getProdottiCarrello().get(i).getProdottoId().isEmpty()
      @           &amp;&amp; carrello.getProdottiCarrello().get(i).getQuantity() &gt;= 0
      @           &amp;&amp; carrello.getProdottiCarrello().get(i).getUnitaryCost() &gt;= 0);
      @   assignable \everything;
      @   ensures available;
      @*/
    public void salvaCarrello(CarrelloBean carrello) {
<span class="nc" id="L36">        String queryCarrello = &quot;INSERT INTO Carrello (cliente_email) VALUES (?)&quot;;</span>
<span class="nc" id="L37">        String queryProdottoCarrello = &quot;INSERT INTO ProdottoCarrello (carrello_id, prodotto_id, quantity, unitary_cost) VALUES (?, ?, ?, ?)&quot;;</span>

<span class="nc" id="L39">        try (Connection connection = ds.getConnection()) {</span>
<span class="nc" id="L40">            try (PreparedStatement psCarrello = connection.prepareStatement(queryCarrello)) {</span>
<span class="nc" id="L41">                psCarrello.setString(1, carrello.getClienteEmail());</span>
<span class="nc" id="L42">                psCarrello.executeUpdate();</span>

<span class="nc bnc" id="L44" title="All 2 branches missed.">                for (ProdottoCarrelloBean prodotto : carrello.getProdottiCarrello()) {</span>
<span class="nc" id="L45">                    try (PreparedStatement psProdottoCarrello = connection.prepareStatement(queryProdottoCarrello)) {</span>
<span class="nc" id="L46">                        psProdottoCarrello.setString(1, carrello.getClienteEmail());</span>
<span class="nc" id="L47">                        psProdottoCarrello.setString(2, prodotto.getProdottoId());</span>
<span class="nc" id="L48">                        psProdottoCarrello.setInt(3, prodotto.getQuantity());</span>
<span class="nc" id="L49">                        psProdottoCarrello.setFloat(4, prodotto.getUnitaryCost());</span>
<span class="nc" id="L50">                        psProdottoCarrello.executeUpdate();</span>
                    }
<span class="nc" id="L52">                }</span>
            }
<span class="nc" id="L54">        } catch (SQLException e) {</span>
<span class="nc" id="L55">            e.printStackTrace();</span>
<span class="nc" id="L56">        }</span>
<span class="nc" id="L57">    }</span>

    @Override
    /*@ public normal_behavior
      @   requires email != null &amp;&amp; !email.isEmpty();
      @   assignable \everything;
      @   ensures \result != null
      @        &amp;&amp; \result.getClienteEmail().equals(email)
      @        &amp;&amp; \result.getProdottiCarrello() != null
      @        &amp;&amp; (\forall int i; 0 &lt;= i &amp;&amp; i &lt; \result.getProdottiCarrello().size();
      @              \result.getProdottiCarrello().get(i) != null
      @           &amp;&amp; \result.getProdottiCarrello().get(i).getProdottoId() != null
      @           &amp;&amp; !\result.getProdottiCarrello().get(i).getProdottoId().isEmpty()
      @           &amp;&amp; \result.getProdottiCarrello().get(i).getQuantity() &gt;= 0
      @           &amp;&amp; \result.getProdottiCarrello().get(i).getUnitaryCost() &gt;= 0);
      @*/
    public CarrelloBean ottieniCarrelloPerEmail(String email) {
<span class="nc" id="L74">        String queryCarrello = &quot;SELECT * FROM Carrello WHERE cliente_email = ?&quot;;</span>
<span class="nc" id="L75">        String queryProdotti = &quot;SELECT * FROM ProdottoCarrello WHERE carrello_id = ?&quot;;</span>

<span class="nc" id="L77">        CarrelloBean carrello = null;</span>
<span class="nc" id="L78">        List&lt;ProdottoCarrelloBean&gt; prodottiCarrello = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L80">        try (Connection connection = ds.getConnection()) {</span>
            // Recupera il carrello
<span class="nc" id="L82">            try (PreparedStatement psCarrello = connection.prepareStatement(queryCarrello)) {</span>
<span class="nc" id="L83">                psCarrello.setString(1, email);</span>
<span class="nc" id="L84">                ResultSet rsCarrello = psCarrello.executeQuery();</span>

<span class="nc bnc" id="L86" title="All 2 branches missed.">                if (rsCarrello.next()) {</span>
                    // Recupera l'ID del carrello
<span class="nc" id="L88">                    int carrelloId = rsCarrello.getInt(&quot;id&quot;);</span>

                    // Recupera i prodotti associati al carrello
<span class="nc" id="L91">                    try (PreparedStatement psProdotti = connection.prepareStatement(queryProdotti)) {</span>
<span class="nc" id="L92">                        psProdotti.setInt(1, carrelloId);</span>
<span class="nc" id="L93">                        ResultSet rsProdotti = psProdotti.executeQuery();</span>

<span class="nc bnc" id="L95" title="All 2 branches missed.">                        while (rsProdotti.next()) {</span>
<span class="nc" id="L96">                            ProdottoCarrelloBean prodotto = new ProdottoCarrelloBean(</span>
                                    email,
<span class="nc" id="L98">                                    rsProdotti.getString(&quot;prodotto_id&quot;),</span>
<span class="nc" id="L99">                                    rsProdotti.getInt(&quot;quantity&quot;),</span>
<span class="nc" id="L100">                                    rsProdotti.getFloat(&quot;unitary_cost&quot;)</span>
                            );
<span class="nc" id="L102">                            prodottiCarrello.add(prodotto);</span>
<span class="nc" id="L103">                        }</span>
                    }

                    // Crea il carrello
<span class="nc" id="L107">                    carrello = new CarrelloBean(email, prodottiCarrello);</span>
                }
            }
<span class="nc" id="L110">        } catch (SQLException e) {</span>
<span class="nc" id="L111">            e.printStackTrace();</span>
<span class="nc" id="L112">        }</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">        return carrello != null ? carrello : new CarrelloBean(email, prodottiCarrello);</span>
    }

    @Override
    /*@ public normal_behavior
      @   requires email != null &amp;&amp; !email.isEmpty();
      @   assignable \everything;
      @   ensures available;
      @*/
    public void clearCartByUserEmail(String email) {
<span class="nc" id="L124">        String queryProdottoCarrello = &quot;DELETE FROM ProdottoCarrello WHERE carrello_id = (SELECT id FROM Carrello WHERE cliente_email = ?)&quot;;</span>
<span class="nc" id="L125">        String queryCarrello = &quot;DELETE FROM Carrello WHERE cliente_email = ?&quot;;</span>
<span class="nc" id="L126">        Connection connection = null;</span>

        try {
<span class="nc" id="L129">            connection = ds.getConnection();</span>

            // Avvia una transazione
<span class="nc" id="L132">            connection.setAutoCommit(false);</span>

<span class="nc" id="L134">            try (PreparedStatement psProdottoCarrello = connection.prepareStatement(queryProdottoCarrello)) {</span>
<span class="nc" id="L135">                psProdottoCarrello.setString(1, email);</span>
<span class="nc" id="L136">                psProdottoCarrello.executeUpdate();</span>
            }

<span class="nc" id="L139">            try (PreparedStatement psCarrello = connection.prepareStatement(queryCarrello)) {</span>
<span class="nc" id="L140">                psCarrello.setString(1, email);</span>
<span class="nc" id="L141">                psCarrello.executeUpdate();</span>
            }

            // Conferma la transazione
<span class="nc" id="L145">            connection.commit();</span>

<span class="nc" id="L147">        } catch (SQLException e) {</span>
<span class="nc" id="L148">            e.printStackTrace();</span>
            try {
                // In caso di errore, esegui il rollback
<span class="nc bnc" id="L151" title="All 2 branches missed.">                if (connection != null) {</span>
<span class="nc" id="L152">                    connection.rollback();</span>
                }
<span class="nc" id="L154">            } catch (SQLException rollbackEx) {</span>
<span class="nc" id="L155">                rollbackEx.printStackTrace();</span>
<span class="nc" id="L156">            }</span>
        } finally {
            try {
                // Ripristina l'auto-commit
<span class="nc bnc" id="L160" title="All 2 branches missed.">                if (connection != null) {</span>
<span class="nc" id="L161">                    connection.setAutoCommit(true);</span>
<span class="nc" id="L162">                    connection.close();</span>
                }
<span class="nc" id="L164">            } catch (SQLException ex) {</span>
<span class="nc" id="L165">                ex.printStackTrace();</span>
<span class="nc" id="L166">            }</span>
        }
<span class="nc" id="L168">    }</span>




}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>